{{/* Put your custom <script></script> tags here */}}

{{/* Mermaid support */}}
{{ if .Page.Store.Get "hasMermaid" }}
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  function getMermaidTheme() {
    return document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'neutral';
  }

  // 保存原始 Mermaid 代码
  document.querySelectorAll('.mermaid').forEach((el) => {
    el.setAttribute('data-mermaid-src', el.textContent);
  });

  mermaid.initialize({
    startOnLoad: true,
    theme: getMermaidTheme()
  });

  // 监听主题切换
  const observer = new MutationObserver(async (mutations) => {
    for (const mutation of mutations) {
      if (mutation.attributeName === 'data-bs-theme') {
        // 重新初始化 Mermaid 主题
        mermaid.initialize({
          startOnLoad: false,
          theme: getMermaidTheme()
        });

        // 重新渲染所有图表
        for (const el of document.querySelectorAll('.mermaid')) {
          const code = el.getAttribute('data-mermaid-src');
          if (code) {
            el.innerHTML = code;
            el.removeAttribute('data-processed');
          }
        }

        await mermaid.run();
      }
    }
  });

  observer.observe(document.documentElement, { attributes: true });
</script>
{{ end }}
